name: Run example pipeline
on:
  workflow_run:
    workflows: ["nf-slack CI"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      nextflow_version:
        description: "Nextflow version to test"
        required: false
        default: "25.10"
        type: choice
        options:
          - "25.10"
      java_version:
        description: "Java version to use"
        required: false
        default: "21"
        type: choice
        options:
          - "17"
          - "21"

jobs:
  run-example:
    name: Test example pipeline
    # Only run if CI tests passed or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        java_version: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('[{0}]', github.event.inputs.java_version)) || fromJSON('[21]') }}
        nextflow_version: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.nextflow_version)) || fromJSON('["25.10"]') }}

    steps:
      - name: Environment
        run: env | sort

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Setup Java ${{ matrix.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{matrix.java_version}}
          architecture: x64
          distribution: "temurin"

      - name: Setup Nextflow ${{ matrix.nextflow_version }}
        uses: nf-core/setup-nextflow@v2
        with:
          version: "${{ matrix.nextflow_version }}"

      - name: Build and install plugin
        run: |
          make clean
          make assemble
          make install
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      - name: Extract plugin version
        id: plugin_version
        run: |
          VERSION=$(grep "^version = " build.gradle | sed "s/version = '\(.*\)'/\1/")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted plugin version: $VERSION"

      - name: Run Configuration Example 1 - Minimal Setup
        run: |
          cd ${{ github.workspace }}/example
          nextflow run main.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }} -c configs/01-minimal.config
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Configuration Example 2 - Notification Control
        run: |
          cd ${{ github.workspace }}/example
          nextflow run main.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }} -c configs/02-notification-control.config
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Configuration Example 3 - Message Text
        run: |
          cd ${{ github.workspace }}/example
          nextflow run main.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }} -c configs/03-message-text.config
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Configuration Example 4 - Message Colors
        run: |
          cd ${{ github.workspace }}/example
          nextflow run main.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }} -c configs/04-message-colors.config
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Configuration Example 5 - Custom Fields
        run: |
          cd ${{ github.workspace }}/example
          nextflow run main.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }} -c configs/05-custom-fields.config
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Configuration Example 6 - Selective Fields
        run: |
          cd ${{ github.workspace }}/example
          nextflow run main.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }} -c configs/06-selective-fields.config
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Script Example 1 - Message in Workflow
        run: |
          cd ${{ github.workspace }}/example
          nextflow run scripts/01-message-in-workflow.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Script Example 2 - Message on Complete
        run: |
          cd ${{ github.workspace }}/example
          nextflow run scripts/02-message-on-complete.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Run Script Example 3 - Message within Channel
        run: |
          cd ${{ github.workspace }}/example
          nextflow run scripts/03-message-within-channel.nf -plugins nf-slack@${{ steps.plugin_version.outputs.version }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
