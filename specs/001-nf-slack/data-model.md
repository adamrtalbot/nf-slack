# Data Model: nf-slack Notification Plugin

**Feature**: nf-slack Notification Plugin
**Date**: 2025-10-30
**Purpose**: Define the data structures and their relationships for the Slack notification plugin

## Overview

The nf-slack plugin is largely stateless - it transforms workflow events and user messages into Slack API payloads. The "entities" are primarily configuration objects, event data structures, and message payloads rather than persistent data models.

## Core Entities

### 1. SlackConfig

**Purpose**: Represents the parsed and validated plugin configuration from `nextflow.config`.

**Attributes**:

- `enabled: Boolean` - Whether the plugin is active (default: true if webhook configured)
- `webhook: String` - Slack Incoming Webhook URL (HTTPS only)
- `notifyOnStart: Boolean` - Send notification on workflow start (default: true)
- `notifyOnComplete: Boolean` - Send notification on workflow completion (default: true)
- `notifyOnError: Boolean` - Send notification on workflow error (default: true)
- `username: String` - Bot display name in Slack (default: "Nextflow Bot")
- `iconEmoji: String` - Bot icon emoji (default: ":rocket:")
- `channel: String` - Override default webhook channel (optional)
- `startMessage: String | MessageTemplate` - Custom start event message
- `completeMessage: String | MessageTemplate` - Custom completion event message
- `errorMessage: String | MessageTemplate` - Custom error event message

**Validation Rules**:

- `webhook` must start with "https://hooks.slack.com/services/"
- At least one of `notifyOnStart`, `notifyOnComplete`, `notifyOnError` must be true
- If `enabled` is true, `webhook` is required
- `username` and `iconEmoji` must not be empty strings if provided

**Relationships**:

- Used by SlackObserver to determine when to send notifications
- Used by SlackClient for webhook URL
- Used by SlackMessageBuilder for customizing message content

**State Transitions**: N/A (immutable after initialization)

---

### 2. MessageTemplate

**Purpose**: Represents advanced message customization configuration (map format).

**Attributes**:

- `text: String` - Main message text (required)
- `color: String` - Hex color code for attachment (optional, e.g., "#2EB887")
- `includeFields: List<String>` - Which default fields to include (optional)
- `customFields: List<Field>` - User-defined fields to add (optional)

**Valid `includeFields` Values**:

- `"runName"` - The Nextflow run name
- `"status"` - Workflow status with emoji
- `"duration"` - How long the workflow ran (not available for start messages)
- `"commandLine"` - The command used to launch the workflow
- `"workDir"` - The work directory (only for start messages)
- `"errorMessage"` - Error details (only for error messages)
- `"failedProcess"` - Which process failed (only for error messages)
- `"tasks"` - Task statistics (only for completion messages)

**Validation Rules**:

- `text` is required
- `color` must be valid hex color if provided (format: #RRGGBB)
- `includeFields` values must be from valid set
- `customFields` must be list of valid Field objects

**Relationships**:

- Used by SlackConfig as type for message configurations
- Used by SlackMessageBuilder to construct Slack attachments

---

### 3. Field

**Purpose**: Represents a single field in a Slack attachment.

**Attributes**:

- `title: String` - Field label (required)
- `value: String` - Field content (required)
- `short: Boolean` - Whether field should appear in column layout (default: false)

**Validation Rules**:

- `title` and `value` are required, non-empty strings
- `title` should be concise (< 50 characters recommended)
- `value` should not exceed 2000 characters

**Relationships**:

- Contained in MessageTemplate's `customFields` list
- Generated by SlackMessageBuilder for default workflow fields

**Example**:

```groovy
[
    title: "Environment",
    value: "Production",
    short: true
]
```

---

### 4. WorkflowEvent

**Purpose**: Represents a workflow lifecycle event captured from Nextflow's TraceObserver.

**Attributes**:

- `type: EventType` - The event type (START, COMPLETE, ERROR)
- `workflowName: String` - Name of the workflow
- `runName: String` - Unique run identifier
- `sessionId: UUID` - Nextflow session ID
- `timestamp: Instant` - When the event occurred
- `duration: Duration` - How long workflow ran (null for START events)
- `commandLine: String` - Full command line used to launch workflow
- `workDir: Path` - Work directory path
- `errorMessage: String` - Error details (only for ERROR events)
- `failedProcess: String` - Name of failed process (only for ERROR events)
- `taskStats: TaskStatistics` - Task execution statistics (only for COMPLETE events)

**Event Types**:

- `START` - Workflow began execution
- `COMPLETE` - Workflow finished successfully
- `ERROR` - Workflow terminated with error

**Validation Rules**:

- All events must have `type`, `workflowName`, `runName`, `sessionId`, `timestamp`
- `COMPLETE` events must have `duration` and `taskStats`
- `ERROR` events must have `errorMessage`

**Relationships**:

- Created by SlackObserver from Nextflow TraceObserver callbacks
- Passed to SlackMessageBuilder for message construction
- Not persisted, only exists during event processing

**State Transitions**:

```
[Workflow Created] -> START event
    |
    v
[Workflow Running]
    |
    +-> [Success] -> COMPLETE event
    |
    +-> [Failure] -> ERROR event
```

---

### 5. TaskStatistics

**Purpose**: Aggregated statistics about task execution in a workflow.

**Attributes**:

- `totalTasks: Integer` - Total number of tasks
- `succeededTasks: Integer` - Number of successful tasks
- `failedTasks: Integer` - Number of failed tasks
- `cachedTasks: Integer` - Number of cached tasks
- `ignoredTasks: Integer` - Number of ignored failures

**Validation Rules**:

- All counts must be non-negative
- `totalTasks` should equal sum of other counts

**Relationships**:

- Contained in WorkflowEvent for COMPLETE events
- Extracted from Nextflow's TraceRecord
- Used by SlackMessageBuilder to format task summary

---

### 6. SlackAttachment

**Purpose**: Represents a formatted Slack Block Kit attachment ready for API submission.

**Attributes**:

- `color: String` - Hex color for attachment sidebar
- `author_name: String` - Workflow name
- `author_icon: String` - Nextflow icon URL
- `title: String` - Message title
- `text: String` - Fallback/notification text
- `fields: List<Field>` - Structured fields
- `footer: String` - Footer text (always "Nextflow")
- `footer_icon: String` - Footer icon URL
- `ts: Long` - Unix timestamp

**Validation Rules**:

- Must conform to Slack Block Kit attachment schema
- Total payload size must not exceed 4000 characters
- Color must be valid hex format

**Relationships**:

- Created by SlackMessageBuilder from WorkflowEvent and MessageTemplate
- Passed to SlackClient for HTTP transmission
- Converted to JSON for Slack API request

---

### 7. SlackMessage

**Purpose**: Complete Slack API request payload.

**Attributes**:

- `text: String` - Fallback text for notifications
- `username: String` - Bot username (optional)
- `icon_emoji: String` - Bot icon (optional)
- `channel: String` - Target channel override (optional)
- `attachments: List<SlackAttachment>` - Rich formatted attachments

**Validation Rules**:

- `text` is required (used when attachments can't render)
- `attachments` list should contain exactly 1 attachment for this plugin
- Total JSON payload must not exceed Slack's 4KB limit

**Relationships**:

- Created by SlackMessageBuilder
- Serialized to JSON by SlackClient
- Sent via HTTP POST to webhook URL

**JSON Example**:

```json
{
  "text": "Workflow completed",
  "username": "Nextflow Bot",
  "icon_emoji": ":rocket:",
  "attachments": [
    {
      "color": "#2EB887",
      "author_name": "My Workflow",
      "author_icon": "https://nextflow.io/icon.png",
      "title": "Workflow completed successfully",
      "fields": [
        { "title": "Run Name", "value": "focused_euler", "short": true },
        { "title": "Duration", "value": "1h 23m", "short": true }
      ],
      "footer": "Nextflow",
      "ts": 1234567890
    }
  ]
}
```

---

## Entity Relationships Diagram

```
SlackConfig
    |
    +---> MessageTemplate (0..3) [startMessage, completeMessage, errorMessage]
    |           |
    |           +---> Field (0..N) [customFields]
    |
    v
SlackObserver
    |
    +---> WorkflowEvent (creates)
    |           |
    |           +---> TaskStatistics (1 for COMPLETE events)
    |
    v
SlackMessageBuilder
    |
    +---> SlackAttachment (creates)
    |           |
    |           +---> Field (N)
    |
    v
SlackMessage (creates)
    |
    +---> SlackAttachment (1)
    |
    v
SlackClient --[HTTP POST]--> Slack API
```

## Data Flow

1. **Configuration Load**:

   ```
   nextflow.config -> ConfigParser -> SlackConfig -> SlackObserver
   ```

2. **Event Processing**:

   ```
   Nextflow TraceObserver
     -> onFlowStart/Complete/Error
     -> SlackObserver
     -> WorkflowEvent (created)
     -> SlackMessageBuilder
     -> SlackMessage
     -> SlackClient
     -> Slack API
   ```

3. **Custom Message**:
   ```
   Workflow DSL
     -> slackMessage()
     -> SlackExtension
     -> SlackMessageBuilder
     -> SlackMessage
     -> SlackClient
     -> Slack API
   ```

## Immutability and Thread Safety

- **SlackConfig**: Immutable after initialization (read-only throughout plugin lifecycle)
- **WorkflowEvent**: Immutable (created once, never modified)
- **MessageTemplate**: Immutable (parsed from config, never modified)
- **SlackMessage**: Immutable (created once, serialized, then discarded)
- **SlackClient**: Thread-safe (uses synchronized blocks for rate limiting)

## Storage and Persistence

**No persistent storage required**:

- All configuration comes from `nextflow.config` (re-read each workflow run)
- Events are processed in memory and discarded after message sent
- No state carried between workflow executions
- No database or file storage needed

This design aligns with the stateless plugin principle and ensures no data persistence concerns.
